import { PrismaClient } from '@prisma/client';
import * as bcrypt from 'bcrypt';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± D√©but du seeding de la base de donn√©es SQLite...');

  // Nettoyage de la base de donn√©es
  console.log('üßπ Nettoyage de la base de donn√©es...');
  await prisma.pinnedMessage.deleteMany();
  await prisma.message.deleteMany();
  await prisma.roomMember.deleteMany();
  await prisma.room.deleteMany();
  await prisma.teamMember.deleteMany();
  await prisma.team.deleteMany();
  await prisma.invitation.deleteMany();
  await prisma.userProfile.deleteMany();
  await prisma.user.deleteMany();

  // Cr√©ation des utilisateurs de test
  console.log('üë• Cr√©ation des utilisateurs...');
  
  const hashedPassword = await bcrypt.hash('password123', 10);
  
  const adminUser = await prisma.user.create({
    data: {
      email: 'admin@eterna.com',
      username: 'admin',
      password: hashedPassword,
      avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=admin',
      bio: 'Administrateur principal d\'ETERNA',
      isOnline: true,
      profile: {
        create: {
          firstName: 'Admin',
          lastName: 'ETERNA',
          location: 'Paris, France',
          website: 'https://eterna.com',
          socialLinks: JSON.stringify({
            twitter: '@eterna_admin',
            linkedin: 'admin-eterna'
          }),
          preferences: JSON.stringify({
            theme: 'dark',
            language: 'fr',
            notifications: true
          })
        }
      }
    }
  });

  const user1 = await prisma.user.create({
    data: {
      email: 'alice@eterna.com',
      username: 'alice',
      password: hashedPassword,
      avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=alice',
      bio: 'D√©veloppeuse passionn√©e',
      isOnline: true,
      profile: {
        create: {
          firstName: 'Alice',
          lastName: 'Dupont',
          location: 'Lyon, France',
          socialLinks: JSON.stringify({
            github: 'alice-dev',
            linkedin: 'alice-dupont'
          }),
          preferences: JSON.stringify({
            theme: 'light',
            language: 'fr',
            notifications: true
          })
        }
      }
    }
  });

  const user2 = await prisma.user.create({
    data: {
      email: 'bob@eterna.com',
      username: 'bob',
      password: hashedPassword,
      avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=bob',
      bio: 'Designer cr√©atif',
      isOnline: false,
      profile: {
        create: {
          firstName: 'Bob',
          lastName: 'Martin',
          location: 'Marseille, France',
          socialLinks: JSON.stringify({
            behance: 'bob-design',
            dribbble: 'bobmartin'
          }),
          preferences: JSON.stringify({
            theme: 'dark',
            language: 'en',
            notifications: false
          })
        }
      }
    }
  });

  const user3 = await prisma.user.create({
    data: {
      email: 'charlie@eterna.com',
      username: 'charlie',
      password: hashedPassword,
      avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=charlie',
      bio: 'Product Manager',
      isOnline: true,
      profile: {
        create: {
          firstName: 'Charlie',
          lastName: 'Wilson',
          location: 'Toulouse, France',
          socialLinks: JSON.stringify({
            linkedin: 'charlie-wilson-pm'
          }),
          preferences: JSON.stringify({
            theme: 'auto',
            language: 'fr',
            notifications: true
          })
        }
      }
    }
  });

  console.log('‚úÖ Utilisateurs cr√©√©s:', { adminUser, user1, user2, user3 });

  // Cr√©ation des √©quipes
  console.log('üè¢ Cr√©ation des √©quipes...');
  
  const team1 = await prisma.team.create({
    data: {
      name: '√âquipe D√©veloppement',
      description: '√âquipe principale de d√©veloppement d\'ETERNA',
      avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=dev-team',
      isPublic: true,
      ownerId: adminUser.id
    }
  });

  const team2 = await prisma.team.create({
    data: {
      name: '√âquipe Design',
      description: '√âquipe de design et UX/UI',
      avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=design-team',
      isPublic: true,
      ownerId: user2.id
    }
  });

  const team3 = await prisma.team.create({
    data: {
      name: '√âquipe Produit',
      description: '√âquipe de gestion de produit',
      avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=product-team',
      isPublic: false,
      ownerId: user3.id
    }
  });

  console.log('‚úÖ √âquipes cr√©√©es:', { team1, team2, team3 });

  // Ajout des membres aux √©quipes
  console.log('üë• Ajout des membres aux √©quipes...');
  
  await prisma.teamMember.createMany({
    data: [
      // √âquipe D√©veloppement
      { userId: adminUser.id, teamId: team1.id, role: 'OWNER' },
      { userId: user1.id, teamId: team1.id, role: 'ADMIN' },
      { userId: user3.id, teamId: team1.id, role: 'MEMBER' },
      
      // √âquipe Design
      { userId: user2.id, teamId: team2.id, role: 'OWNER' },
      { userId: user1.id, teamId: team2.id, role: 'MEMBER' },
      
      // √âquipe Produit
      { userId: user3.id, teamId: team3.id, role: 'OWNER' },
      { userId: adminUser.id, teamId: team3.id, role: 'ADMIN' }
    ]
  });

  console.log('‚úÖ Membres ajout√©s aux √©quipes');

  // Cr√©ation des salons
  console.log('üí¨ Cr√©ation des salons...');
  
  const room1 = await prisma.room.create({
    data: {
      name: 'g√©n√©ral',
      description: 'Salon g√©n√©ral pour toute l\'√©quipe',
      avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=general-room',
      isPrivate: false,
      isDirect: false,
      maxMembers: 100,
      teamId: team1.id,
      ownerId: adminUser.id
    }
  });

  const room2 = await prisma.room.create({
    data: {
      name: 'd√©veloppement',
      description: 'Salon d√©di√© au d√©veloppement',
      avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=dev-room',
      isPrivate: false,
      isDirect: false,
      maxMembers: 50,
      teamId: team1.id,
      ownerId: user1.id
    }
  });

  const room3 = await prisma.room.create({
    data: {
      name: 'design-ux',
      description: 'Salon pour les discussions design',
      avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=design-room',
      isPrivate: false,
      isDirect: false,
      maxMembers: 30,
      teamId: team2.id,
      ownerId: user2.id
    }
  });

  // Salon priv√©
  const room4 = await prisma.room.create({
    data: {
      name: 'planning-produit',
      description: 'Salon priv√© pour la planification produit',
      avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=planning-room',
      isPrivate: true,
      isDirect: false,
      maxMembers: 20,
      teamId: team3.id,
      ownerId: user3.id
    }
  });

  console.log('‚úÖ Salons cr√©√©s:', { room1, room2, room3, room4 });

  // Ajout des membres aux salons
  console.log('üë• Ajout des membres aux salons...');
  
  await prisma.roomMember.createMany({
    data: [
      // Salon g√©n√©ral
      { userId: adminUser.id, roomId: room1.id, role: 'OWNER' },
      { userId: user1.id, roomId: room1.id, role: 'ADMIN' },
      { userId: user2.id, roomId: room1.id, role: 'MEMBER' },
      { userId: user3.id, roomId: room1.id, role: 'MEMBER' },
      
      // Salon d√©veloppement
      { userId: user1.id, roomId: room2.id, role: 'OWNER' },
      { userId: adminUser.id, roomId: room2.id, role: 'ADMIN' },
      { userId: user3.id, roomId: room2.id, role: 'MEMBER' },
      
      // Salon design
      { userId: user2.id, roomId: room3.id, role: 'OWNER' },
      { userId: user1.id, roomId: room3.id, role: 'MEMBER' },
      
      // Salon planning (priv√©)
      { userId: user3.id, roomId: room4.id, role: 'OWNER' },
      { userId: adminUser.id, roomId: room4.id, role: 'ADMIN' }
    ]
  });

  console.log('‚úÖ Membres ajout√©s aux salons');

  // Cr√©ation des messages
  console.log('üí¨ Cr√©ation des messages...');
  
  const message1 = await prisma.message.create({
    data: {
      content: 'Bienvenue dans le salon g√©n√©ral d\'ETERNA ! üéâ',
      type: 'TEXT',
      userId: adminUser.id,
      roomId: room1.id
    }
  });

  const message2 = await prisma.message.create({
    data: {
      content: 'Salut tout le monde ! Ravi de rejoindre l\'√©quipe üòä',
      type: 'TEXT',
      userId: user1.id,
      roomId: room1.id
    }
  });

  const message3 = await prisma.message.create({
    data: {
      content: 'Bonjour ! Je suis Charlie, le nouveau PM. Heureux de travailler avec vous !',
      type: 'TEXT',
      userId: user3.id,
      roomId: room1.id
    }
  });

  const message4 = await prisma.message.create({
    data: {
      content: 'Quelqu\'un a des questions sur la nouvelle interface ?',
      type: 'TEXT',
      userId: user2.id,
      roomId: room3.id
    }
  });

  const message5 = await prisma.message.create({
    data: {
      content: 'Oui, j\'aimerais discuter de l\'UX du dashboard !',
      type: 'TEXT',
      userId: user1.id,
      roomId: room3.id
    }
  });

  console.log('‚úÖ Messages cr√©√©s:', { message1, message2, message3, message4, message5 });

  // Cr√©ation d'invitations
  console.log('üìß Cr√©ation d\'invitations...');
  
  const invitation1 = await prisma.invitation.create({
    data: {
      email: 'newdev@eterna.com',
      teamId: team1.id,
      role: 'MEMBER',
      status: 'PENDING',
      expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 jours
      senderId: adminUser.id
    }
  });

  const invitation2 = await prisma.invitation.create({
    data: {
      email: 'designer@eterna.com',
      teamId: team2.id,
      role: 'MEMBER',
      status: 'PENDING',
      expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 jours
      senderId: user2.id
    }
  });

  console.log('‚úÖ Invitations cr√©√©es:', { invitation1, invitation2 });

  // Message √©pingl√©
  console.log('üìå √âpinglage d\'un message...');
  
  await prisma.pinnedMessage.create({
    data: {
      messageId: message1.id,
      roomId: room1.id,
      pinnedBy: adminUser.id
    }
  });

  console.log('‚úÖ Message √©pingl√©');

  console.log('üéâ Seeding termin√© avec succ√®s !');
  console.log('\nüìä R√©sum√©:');
  console.log(`- ${await prisma.user.count()} utilisateurs cr√©√©s`);
  console.log(`- ${await prisma.team.count()} √©quipes cr√©√©es`);
  console.log(`- ${await prisma.room.count()} salons cr√©√©s`);
  console.log(`- ${await prisma.message.count()} messages cr√©√©s`);
  console.log(`- ${await prisma.invitation.count()} invitations cr√©√©es`);
  
  console.log('\nüîë Comptes de test:');
  console.log('admin@eterna.com / password123');
  console.log('alice@eterna.com / password123');
  console.log('bob@eterna.com / password123');
  console.log('charlie@eterna.com / password123');
  
  console.log('\nüóÑÔ∏è Base de donn√©es SQLite cr√©√©e: dev.db');
  console.log('üåê Serveur: http://localhost:8080');
  console.log('üìä Swagger: http://localhost:8080/api/docs');
}

main()
  .catch((e) => {
    console.error('‚ùå Erreur lors du seeding:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
